<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="SerDigital64">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://serdigital64.github.io/from-serdigital64-flicker/DSC-1031-wide.jpg">
    <meta property="twitter:image" content="https://serdigital64.github.io/from-serdigital64-flicker/DSC-1031-wide.jpg" />
    

    
    <meta name="title" content="Implementing infrastructure-as-code with Ansible and GIT" />
    <meta property="og:title" content="Implementing infrastructure-as-code with Ansible and GIT" />
    <meta property="twitter:title" content="Implementing infrastructure-as-code with Ansible and GIT" />
    

    
    <meta name="description" content="Blog dedicated to sharing personal experiences and knowledge on Information Technology topics">
    <meta property="og:description" content="Blog dedicated to sharing personal experiences and knowledge on Information Technology topics" />
    <meta property="twitter:description" content="Blog dedicated to sharing personal experiences and knowledge on Information Technology topics" />
    

    
    <meta property="twitter:card" content="Manage compute nodes using the infrastructure-as-code concept using Ansible and GIT" />
    
    

    <meta name="keyword"  content="information technology blog">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Implementing infrastructure-as-code with Ansible and GIT-Information Technology Blog</title>

    <link rel="canonical" href="/post/ansible/implementing-infrastructure-as-code-with-ansible-and-git/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GWJGTNQ8CQ"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-GWJGTNQ8CQ');
    gtag('config', 'UA-202533179-1');
    </script>

</head>



<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">SerDigital64</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/image-gallery">image-gallery</a>
                        </li>
                        
                        <li>
                            <a href="/categories/tutorials">tutorials</a>
                        </li>
                        
                    
                    
		    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/from-serdigital64-flicker/DSC_7075-wide.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/ansible" title="ansible">
                            ansible
                        </a>
                        
                        <a class="tag" href="/tags/linux" title="Linux">
                            Linux
                        </a>
                        
                        <a class="tag" href="/tags/automation" title="automation">
                            automation
                        </a>
                        
                        <a class="tag" href="/tags/devops" title="devops">
                            devops
                        </a>
                        
                        <a class="tag" href="/tags/infrastructure-as-code" title="infrastructure-as-code">
                            infrastructure-as-code
                        </a>
                        
                        <a class="tag" href="/tags/sysadmin" title="sysadmin">
                            sysadmin
                        </a>
                        
                    </div>
                    <h1>Implementing infrastructure-as-code with Ansible and GIT</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by 
                        
                                SerDigital64
                         
                        on 
                        Saturday, September 4, 2021
                        
                        
                        
                        <br>Last Modified on Saturday, September 18, 2021
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="what-is-infrastructure-as-code">What is &ldquo;infrastructure-as-code&rdquo;?</h2>
<p>To keep the concept simple, think of your infrastructure as a picture (end-state) and the main characteristics (configuration) that you would use to describe it.</p>
<p>Using this information you should be able to reproduce the picture any time you need, and the result should always be the same as the original.</p>
<p>There are several tools and methods to implement this approach but the most important thing to consider is that you also need to adapt your management procedures to switch from the traditional imperative model to the infrastructure-as-code declarative model.</p>
<h2 id="challenges">Challenges</h2>
<p>To successfully implement infrastructure-as-code special attention must be paid to the selection of supporting tools and the definition of the conceptual model that will represent the managed environment:</p>
<ul>
<li>Automation tool: takes control of the infrastructure configuration and performs the necessary actions to reach the desired end-state.</li>
<li>Code Repository and Versioning: stores the infrastructure-model and automation scripts to manage the infrastructure and tracks changes.</li>
<li>Infrastructure-model: conceptual data model that describes the desired end-state of the infrastructure.</li>
</ul>
<h2 id="implementing-infrastructure-as-code">Implementing infrastructure-as-code</h2>
<p>Let&rsquo;s take the following example scenario to demonstrate the implementation procedure:</p>
<ul>
<li>Environment: Home Office</li>
<li>Ansible Control Node: small PC or VM installed with Centos 8.4</li>
<li>Ansible Managed Nodes: notebooks with Ubuntu and workstations with Centos and Fedora</li>
</ul>
<p>
  <img src="/diagrams/implementing-infrastructure-as-code-with-ansible-and-git-1.png" alt="Home Office Site">

</p>
<p>Before starting the implementation procedure, make sure the following requirements are meet:</p>
<ul>
<li>Control Node:
<ul>
<li>OpenSSH client</li>
<li>Sudo</li>
<li>Python3</li>
<li>GIT</li>
<li>Regular user with SUDO configured for password less root privilege</li>
</ul>
</li>
<li>Managed Nodes:
<ul>
<li>Fresh OS install (standard setup)</li>
<li>OpenSSH server</li>
<li>Sudo</li>
<li>Python3</li>
<li>Regular user with SUDO configured for password less root privilege</li>
</ul>
</li>
</ul>
<h3 id="define-the-infrastructure-model">Define the Infrastructure Model</h3>
<p>The infrastructure-model will have the following data structures:</p>
<ul>
<li><strong>Site</strong>: Represents a group of <strong>Nodes</strong> that are managed by the same <strong>Control Node</strong>.</li>
<li><strong>Node</strong>: Compute node that is capable of hosting software components and that is fully managed by the Control Node.</li>
<li><strong>Component</strong>: Individual software product that is installed in a <strong>Node</strong>.</li>
<li><strong>Service</strong>: Group of <strong>Components</strong> configured in one or more <strong>Nodes</strong> to serve a particular function.</li>
</ul>
<p>The data structures will be implemented using Ansible inventories, host_vars, and group_vars:</p>
<ul>
<li><strong>Inventory</strong>: the <code>hosts.ini</code> file will be used to declare all the <strong>Nodes</strong> for the target <strong>Site</strong>. <strong>Nodes</strong> will be grouped based on the <strong>Service</strong> they provide or use.</li>
<li><strong>GroupVars</strong>: individual YAML files for <strong>Components</strong> and <strong>Services</strong> will be created for each <strong>Node</strong> group declared in the <strong>Inventory</strong>.</li>
<li><strong>HostVars</strong>: individual YAML files will be used for cases where the <strong>Node</strong> requires further customization.</li>
</ul>
<h3 id="create-the-code-repository">Create the Code Repository</h3>
<p>Create a dedicated Linux account. This is to isolate content from regular users and facilitate activity auditing. Modify the shell variable <code>PROJECT_OWNER</code> to change the default name.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PROJECT_OWNER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sitectl&#39;</span>
sudo useradd -m <span style="color:#e6db74">&#34;</span>$PROJECT_OWNER<span style="color:#e6db74">&#34;</span>
sudo su - <span style="color:#e6db74">&#34;</span>$PROJECT_OWNER<span style="color:#e6db74">&#34;</span>

</code></pre></div><p>Create the project directory structure that will contain the infrastructure-model and automation scripts. Refer to the <a href="https://docs.ansible.com/ansible/2.8/user_guide/playbooks_best_practices.html#directory-layout">Ansible Best Practices</a> document to further learn about the directory structure.
Modify the shell variable <code>PROJECT_PATH</code> to change the default project location.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">export PROJECT_OWNER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sitectl&#39;</span>
export PROJECT_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/home/</span><span style="color:#e6db74">${</span>PROJECT_OWNER<span style="color:#e6db74">}</span><span style="color:#e6db74">/manager&#34;</span>
mkdir <span style="color:#e6db74">&#34;</span>$PROJECT_PATH<span style="color:#e6db74">&#34;</span>
cd <span style="color:#e6db74">&#34;</span>$PROJECT_PATH<span style="color:#e6db74">&#34;</span>
mkdir <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;collections&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;files&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;inventories&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;inventories/group_vars&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;inventories/host_vars&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;playbooks&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;vars&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;etc&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;filter_plugins&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;library&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;module_utils&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;roles&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;var&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#39;templates&#39;</span>

</code></pre></div><p>Create a simple shell script to set environment variables for Ansible. Refer to the <a href="https://docs.ansible.com/ansible/latest/reference_appendices/config.html">Ansible Configuration</a> documentation to understand what are the <code>ANSIBLE_*</code> shell variables doing.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; <span style="color:#e6db74">&#39;load_environment.sh&#39;</span> <span style="color:#e6db74">&lt;&lt;-EEOF
</span><span style="color:#e6db74">#!/bin/bash
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">declare -x PROJECT_OWNER=&#39;$PROJECT_OWNER&#39;
</span><span style="color:#e6db74">declare -x PROJECT_PATH=&#39;$PROJECT_PATH&#39;
</span><span style="color:#e6db74">declare -x PROJECT_END_STATE=&#39;${PROJECT_PATH}/inventories&#39;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">declare -x ANSIBLE_INVENTORY=&#34;\${PROJECT_END_STATE}/hosts.ini&#34;
</span><span style="color:#e6db74">declare -x ANSIBLE_PRIVATE_KEY_FILE=&#34;/home/\${PROJECT_OWNER}/.ssh/id_rsa&#34;
</span><span style="color:#e6db74">declare -x ANSIBLE_COLLECTIONS_PATHS=&#34;\${PROJECT_PATH}/collections&#34;
</span><span style="color:#e6db74">declare -x ANSIBLE_ROLES_PATH=&#34;\${PROJECT_PATH}/roles&#34;
</span><span style="color:#e6db74">declare -x ANSIBLE_GALAXY_CACHE_DIR=&#34;\${PROJECT_PATH}/var&#34;
</span><span style="color:#e6db74">declare -x ANSIBLE_LOG_PATH=&#34;\${PROJECT_PATH}/var/ansible.log&#34;
</span><span style="color:#e6db74">declare -x ANSIBLE_PYTHON_INTERPRETER=&#39;/usr/bin/python3.9&#39;
</span><span style="color:#e6db74">declare -x ANSIBLE_PLAYBOOK_DIR=&#34;\${PROJECT_PATH}/playbooks&#34;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">PATH=&#39;/home/${PROJECT_OWNER}/.local/bin:/usr/bin:/usr/sbin&#39;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">EEOF</span>

</code></pre></div><p>Create the Code Repository using GIT. Configure the <code>.gitignore</code> file to avoid tracking changes in the ansible-galaxy install location target (<code>collections/</code>) and in the repository for temporary and volatile files (<code>/var</code>)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">source load_environment.sh
cat &gt; <span style="color:#e6db74">&#39;.gitignore&#39;</span> <span style="color:#e6db74">&lt;&lt;-EEOF
</span><span style="color:#e6db74">collections/
</span><span style="color:#e6db74">var/
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">EEOF</span>
git config user.email <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PROJECT_OWNER<span style="color:#e6db74">}</span><span style="color:#e6db74">@localhost.localdomain&#34;</span>
git config user.name <span style="color:#e6db74">&#34;</span>$PROJECT_OWNER<span style="color:#e6db74">&#34;</span>
git init
git add .
git commit -m <span style="color:#e6db74">&#34;Initial commit&#34;</span>

</code></pre></div><h3 id="configure-ansible">Configure Ansible</h3>
<p>Install the latest Ansible engine to the control node user. This method keeps the environment isolated, minimizes os-distribution dependencies, and facilitates module upgrades.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#e6db74">&#34;</span>$ANSIBLE_PYTHON_INTERPRETER<span style="color:#e6db74">&#34;</span> -m pip install ansible

</code></pre></div><p>Prepare remote access to Ansible Managed Nodes using OpenSSH keys. Modify the shell variable <code>PROJECT_MANAGED_NODES</code> to represent your environment and set the <code>PROJECT_MANAGED_USER</code> variable to the remote user name with password-less root privilege.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PROJECT_MANAGED_NODES<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;host1 host2 host3 host4&#39;</span>
PROJECT_MANAGED_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sysadmin&#39;</span>
ssh-keygen -t rsa -f <span style="color:#e6db74">&#34;</span>$ANSIBLE_PRIVATE_KEY_FILE<span style="color:#e6db74">&#34;</span> -N <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#66d9ef">for</span> x in $PROJECT_MANAGED_NODES; <span style="color:#66d9ef">do</span>
  ssh-copy-id -i <span style="color:#e6db74">&#34;</span>$ANSIBLE_PRIVATE_KEY_FILE<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">${</span>PROJECT_MANAGED_USER<span style="color:#e6db74">}</span>@<span style="color:#e6db74">${</span>x<span style="color:#e6db74">}</span>
<span style="color:#66d9ef">done</span>

</code></pre></div><p>Create the initial Ansible inventory registering the following <strong>Node</strong> groups:</p>
<ul>
<li><code>[control_node]</code>: defines the Ansible Node.</li>
<li><code>[managed_nodes]</code>: defines Ansible Managed nodes for the target site.</li>
<li><code>[office_nodes]</code>: defines <strong>Nodes</strong> that will consume the <strong>office-service</strong>. The service provides users with common productivity applications. For this example, we&rsquo;ll use the image editor GIMP.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; <span style="color:#e6db74">&#34;</span>$ANSIBLE_INVENTORY<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&lt;&lt;-EEOF
</span><span style="color:#e6db74">[control_node]
</span><span style="color:#e6db74">localhost
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[managed_nodes]
</span><span style="color:#e6db74">$(for x in $PROJECT_MANAGED_NODES; do echo &#34;$x&#34;; done)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[office_nodes]
</span><span style="color:#e6db74">$(for x in $PROJECT_MANAGED_NODES; do echo &#34;$x&#34;; done)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">EEOF</span>

</code></pre></div><p>Create end-state configuration repositories. This is where the infrastructure-model will be implemented.</p>
<ul>
<li><code>group_vars/</code>: one directory per host group</li>
<li><code>group_vars/host_group_x/</code>: one or more YAML files representing the components that will be available for all hosts in the group</li>
<li><code>host_vars/</code>: one directory per host</li>
<li><code>host_vars/hostx/</code>: one or more YAML files representing the components that will be available for the host</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#66d9ef">for</span> x in control_node managed_nodes office_nodes; <span style="color:#66d9ef">do</span>
  mkdir <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PROJECT_END_STATE<span style="color:#e6db74">}</span><span style="color:#e6db74">/group_vars/</span><span style="color:#e6db74">${</span>x<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">done</span>
<span style="color:#66d9ef">for</span> x in $PROJECT_MANAGED_NODES; <span style="color:#66d9ef">do</span>
  mkdir <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PROJECT_END_STATE<span style="color:#e6db74">}</span><span style="color:#e6db74">/host_vars/</span><span style="color:#e6db74">${</span>x<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">done</span>

</code></pre></div><h3 id="define-component-end-states">Define component end-states</h3>
<p>Now that the data repository for the infrastructure-model is created it can be populated with end-state targets. Notice that you can also add behaviour definitions to keep variable data separated from the code.</p>
<p>Define how is the Ansible engine going to connect to the managed nodes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; <span style="color:#e6db74">&#34;</span>$PROJECT_END_STATE<span style="color:#e6db74">/group_vars/managed_nodes/ansible.yml&#34;</span> <span style="color:#e6db74">&lt;&lt;-EEOF
</span><span style="color:#e6db74">---
</span><span style="color:#e6db74">ansible_user: &#34;$PROJECT_MANAGED_USER&#34;
</span><span style="color:#e6db74">ansible_become_method: &#34;sudo&#34;
</span><span style="color:#e6db74">...
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">EEOF</span>

</code></pre></div><p>Define the attributes for the <code>Linux Users</code> component. This definition will be applied to all hosts in the group <code>managed_nodes</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; <span style="color:#e6db74">&#34;</span>$PROJECT_END_STATE<span style="color:#e6db74">/group_vars/managed_nodes/users.yml&#34;</span> <span style="color:#e6db74">&lt;&lt;-EEOF
</span><span style="color:#e6db74">---
</span><span style="color:#e6db74">managed_nodes_users:
</span><span style="color:#e6db74">  - name: &#34;user1&#34;
</span><span style="color:#e6db74">    description: &#34;Regular User 1&#34;
</span><span style="color:#e6db74">    uid: &#34;10100&#34;
</span><span style="color:#e6db74">  - name: &#34;user2&#34;
</span><span style="color:#e6db74">    description: &#34;Regular User 2&#34;
</span><span style="color:#e6db74">    uid: &#34;10101&#34;
</span><span style="color:#e6db74">...
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">EEOF</span>

</code></pre></div><p>Define the attributes for the <code>Linux Package</code> component. This definition will be applied to all hosts in the group <code>office_nodes</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; <span style="color:#e6db74">&#34;</span>$PROJECT_END_STATE<span style="color:#e6db74">/group_vars/office_nodes/packages.yml&#34;</span> <span style="color:#e6db74">&lt;&lt;-EEOF
</span><span style="color:#e6db74">---
</span><span style="color:#e6db74">office_nodes_packages:
</span><span style="color:#e6db74">  flatpak:
</span><span style="color:#e6db74">    - &#34;flatpak&#34;
</span><span style="color:#e6db74">  gimp:
</span><span style="color:#e6db74">    - &#34;org.gimp.GIMP&#34;
</span><span style="color:#e6db74">...
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">EEOF</span>

</code></pre></div><h3 id="bring-the-site-to-the-target-end-state">Bring the site to the target end-state</h3>
<p>At this point end-state, and behaviour definitions are set. Now it&rsquo;s time to write the code that will apply it to the target hosts.</p>
<p>Create the Ansible Playbook that will configure the <code>managed_nodes</code> host group:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; <span style="color:#e6db74">&#34;</span>$ANSIBLE_PLAYBOOK_DIR<span style="color:#e6db74">/managed_nodes.yml&#34;</span> <span style="color:#e6db74">&lt;&lt;-EEOF
</span><span style="color:#e6db74">---
</span><span style="color:#e6db74">- name: &#34;Manage Ansible Nodes&#34;
</span><span style="color:#e6db74">  hosts: &#34;managed_nodes&#34;
</span><span style="color:#e6db74">  gather_facts: false
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  tasks:
</span><span style="color:#e6db74">    - name: &#34;Create Regular User Accounts&#34;
</span><span style="color:#e6db74">      become: true
</span><span style="color:#e6db74">      ansible.builtin.user:
</span><span style="color:#e6db74">        create_home: true
</span><span style="color:#e6db74">        state: &#34;present&#34;
</span><span style="color:#e6db74">        name: &#34;{{ item[&#39;name&#39;] }}&#34;
</span><span style="color:#e6db74">        comment: &#34;{{ item[&#39;description&#39;] | default( omit ) }}&#34;
</span><span style="color:#e6db74">        uid: &#34;{{ item[&#39;uid&#39;] | default( omit ) }}&#34;
</span><span style="color:#e6db74">      loop: &#34;{{ managed_nodes_users }}&#34;
</span><span style="color:#e6db74">...
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">EEOF</span>

</code></pre></div><p>Create the Ansible Playbook that will configure the <code>office_nodes</code> host group:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat &gt; <span style="color:#e6db74">&#34;</span>$ANSIBLE_PLAYBOOK_DIR<span style="color:#e6db74">/office_nodes.yml&#34;</span> <span style="color:#e6db74">&lt;&lt;-EEOF
</span><span style="color:#e6db74">---
</span><span style="color:#e6db74">- name: &#34;Manage Office Nodes&#34;
</span><span style="color:#e6db74">  hosts: &#34;office_nodes&#34;
</span><span style="color:#e6db74">  gather_facts: false
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  pre_tasks:
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    - name: &#34;Install FlatPak tools&#34;
</span><span style="color:#e6db74">      become: true
</span><span style="color:#e6db74">      ansible.builtin.package:
</span><span style="color:#e6db74">        name: &#34;{{ office_nodes_packages[&#39;flatpak&#39;] }}&#34;
</span><span style="color:#e6db74">        state: &#34;present&#34;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    - name: &#34;Prepare FlatPak repository&#34;
</span><span style="color:#e6db74">      become: true
</span><span style="color:#e6db74">      ansible.builtin.command:
</span><span style="color:#e6db74">        argv:
</span><span style="color:#e6db74">          - &#34;/usr/bin/flatpak&#34;
</span><span style="color:#e6db74">          - &#34;--system&#34;
</span><span style="color:#e6db74">          - &#34;remote-add&#34;
</span><span style="color:#e6db74">          - &#34;flatpak&#34;
</span><span style="color:#e6db74">          - &#34;https://flathub.org/repo/flathub.flatpakrepo&#34;
</span><span style="color:#e6db74">      register: result
</span><span style="color:#e6db74">      changed_when:
</span><span style="color:#e6db74">        - result[&#39;rc&#39;] == 0
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  tasks:
</span><span style="color:#e6db74">    - name: &#34;Install GIMP from FlatHub&#34;
</span><span style="color:#e6db74">      become: true
</span><span style="color:#e6db74">      community.general.flatpak:
</span><span style="color:#e6db74">        name: &#34;{{ office_nodes_packages[&#39;gimp&#39;] }}&#34;
</span><span style="color:#e6db74">        state: &#34;present&#34;
</span><span style="color:#e6db74">...
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">EEOF</span>

</code></pre></div><p>Execute the playbooks to apply the end-state:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">ansible-playbook playbooks/managed_nodes.yml
ansible-playbook playbooks/office_nodes.yml

</code></pre></div><p>Save the changes to the repository:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git add inventories
git add playbooks
git commit -m <span style="color:#e6db74">&#34;add office_node and managed_node plays&#34;</span>

</code></pre></div><h2 id="next-steps">Next steps</h2>
<p>Now the base structure is up and running more content can be added, either from Ansible Galaxy or developed in-house.</p>
<p>In addition to the automation engine and code repository you should evaluate incorporating:</p>
<ul>
<li>Code linters: <a href="https://ansible-lint.readthedocs.io/en/latest/">Ansible Lint</a> and <a href="https://yamllint.readthedocs.io/en/stable/">YAMLlint</a> can help to keep code consistent and standardized.</li>
<li>Testing: <a href="https://molecule.readthedocs.io/en/latest/">Ansible Molecule</a> can be used to build and run test environments for testing in-house roles</li>
<li>Provisioning: <a href="https://www.terraform.io/docs/index.html">Terraform</a> can be used to automate the creation of standardized VMs</li>
</ul>
<p>Explore the <a href="https://readthedocs.org/projects/aplatform64/">A:Platform64</a> project that facilitates the implementation of infrastructure-as-code by automating most of the tasks described in this tutorial.</p>


                <hr>
                
                <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                    <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
                </a>
                Copyright information: this article is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
                For copyright information on the product or products mentioned inhere refer to their respective owner.
                <hr>
                Disclaimer: opinions presented in this article are personal and belong solely to me, and do not represent people or organizations associated with me in a professional or personal way.
                All the information on this site is provided "as is" with no guarantee of completeness, accuracy or the results obtained from the use of this information.
                <hr>
                

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/ansible/ansible-concepts-for-sysadmins/" data-toggle="tooltip" data-placement="top" title="Ansible Concepts for SysAdmins">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-11 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="SerDigital64" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    

                    
                    
                    

                    

		    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.github.com/serdigital64">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
            <li>
                <a target="_blank" href="https://www.flickr.com/people/serdigital64/">
                    <span class="fa-stack fa-lg">
                        <i class="fas fa-circle fa-stack-2x"></i>
                        <i class="fab fa-flickr fa-stack-1x fa-inverse"></i>
                    </span>
                </a>
            </li>
    
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; SerDigital64 2021
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






</body>
</html>
